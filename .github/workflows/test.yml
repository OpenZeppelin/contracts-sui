name: Lint and Test

on:
  push:
    branches: [main, v*]
  pull_request:
    branches: [main, v*]

# Cancel in-progress runs on new pushes to the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  SUI_VERSION: "1.59.1"

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      packages: ${{ steps.set-matrix.outputs.packages }}
    steps:
      - name: Set package matrix
        id: set-matrix
        run: |
          PACKAGES='["math/core", "contracts/access"]'
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: Cache Sui binary
        id: cache-sui
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/sui
          key: sui-${{ runner.os }}-${{ env.SUI_VERSION }}

      - name: Install Sui CLI from binary
        if: steps.cache-sui.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.local/bin
          curl -fLJ https://github.com/MystenLabs/sui/releases/download/mainnet-v${{ env.SUI_VERSION }}/sui-mainnet-v${{ env.SUI_VERSION }}-ubuntu-x86_64.tgz -o sui.tgz
          tar -xzf sui.tgz
          chmod +x sui
          mv sui ~/.local/bin/

      - name: Verify Sui installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          sui --version

  check-move-formatting:
    name: Move Formatter Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Move formatting
        uses: MystenLabs/move-formatter-action@v1
        with:
          prettier-plugin-move-version: "latest"
          working-directory: "."
          pattern: "**/*.move"
          write-changes: false

  lint:
    name: Lint ${{ matrix.package }}
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: true
      matrix:
        package: ${{ fromJson(needs.setup.outputs.packages) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore Sui CLI
        uses: ./.github/actions/restore-sui
        with:
          version: ${{ env.SUI_VERSION }}

      - name: Set package slug
        id: set-slug
        run: |
          package_slug="${{ matrix.package }}"
          package_slug="${package_slug//\//-}"
          echo "package_slug=$package_slug" >> $GITHUB_OUTPUT

      - name: Lint
        run: sui move build --lint --warnings-are-errors
        working-directory: ./${{ matrix.package }}

      - name: Lint tests
        run: sui move build --test --lint --warnings-are-errors
        working-directory: ./${{ matrix.package }}

  test:
    name: Test ${{ matrix.package }}
    needs: [setup, lint]
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
      pull-requests: write
    strategy:
      fail-fast: true
      matrix:
        package: ${{ fromJson(needs.setup.outputs.packages) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore Sui CLI
        uses: ./.github/actions/restore-sui
        with:
          version: ${{ env.SUI_VERSION }}

      - name: Set package slug
        id: set-slug
        run: |
          package_slug="${{ matrix.package }}"
          package_slug="${package_slug//\//-}"
          echo "package_slug=$package_slug" >> $GITHUB_OUTPUT

      - name: Run all tests
        run: sui move test --trace --coverage
        working-directory: ./${{ matrix.package }}

      - name: Generate Codecov report (all)
        run: sui move coverage lcov > lcov-all.info
        working-directory: ./${{ matrix.package }}

      - name: Upload coverage to Codecov (all)
        uses: codecov/codecov-action@v5
        with:
          files: ./${{ matrix.package }}/lcov-all.info
          flags: ${{ matrix.package }}
          name: ${{ matrix.package }}-all
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Run AI-only tests
        id: ai-tests
        run: |
          sui move test --trace --coverage '::ai_'
          if [ -f ./.trace ]; then
            echo "trace_found=true" >> $GITHUB_OUTPUT
          else
            echo "trace_found=false" >> $GITHUB_OUTPUT
          fi
        working-directory: ./${{ matrix.package }}

      - name: Generate Codecov report (ai)
        if: ${{ steps.ai-tests.outputs.trace_found == 'true' }}
        run: sui move coverage lcov > lcov-${{ steps.set-slug.outputs.package_slug }}-ai.info
        working-directory: ./${{ matrix.package }}

      - name: Upload coverage to Codecov (ai)
        if: ${{ steps.ai-tests.outputs.trace_found == 'true' }}
        uses: codecov/codecov-action@v5
        with:
          files: ./${{ matrix.package }}/lcov-${{ steps.set-slug.outputs.package_slug }}-ai.info
          flags: ${{ matrix.package }}-ai
          name: ${{ matrix.package }}-ai
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Run dev-only tests
        id: dev-tests
        run: |
          sui move test --trace --coverage '::([^a][^:]*|a[^i][^:]*|ai[^_][^:]*)$'
          if [ -f ./.trace ]; then
            echo "trace_found=true" >> $GITHUB_OUTPUT
          else
            echo "trace_found=false" >> $GITHUB_OUTPUT
          fi
        working-directory: ./${{ matrix.package }}

      - name: Generate Codecov report (dev)
        if: ${{ steps.dev-tests.outputs.trace_found == 'true' }}
        run: sui move coverage lcov > lcov-${{ steps.set-slug.outputs.package_slug }}-dev.info
        working-directory: ./${{ matrix.package }}

      - name: Upload coverage to Codecov (dev)
        if: ${{ steps.dev-tests.outputs.trace_found == 'true' }}
        uses: codecov/codecov-action@v5
        with:
          files: ./${{ matrix.package }}/lcov-${{ steps.set-slug.outputs.package_slug }}-dev.info
          flags: ${{ matrix.package }}-dev
          name: ${{ matrix.package }}-dev
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
